name: ポータブルEXEビルド

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:  # 手動実行用

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v3
      
      - name: Node.jsのセットアップ
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - name: pnpmのセットアップ
        uses: pnpm/action-setup@v2
        with:
          version: latest
          run_install: false
      
      - name: pnpmキャッシュの設定
        uses: actions/cache@v3
        with:
          path: |
            .pnpm-store
            node_modules
            renderer/.next/cache
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      
      - name: 依存関係のインストール
        run: pnpm install

      - name: ディレクトリ構造を確認・作成
        run: |
          echo "現在のディレクトリ構造を表示"
          dir
          echo "rendererディレクトリの内容"
          dir renderer || mkdir renderer
          echo "renderer/appディレクトリの作成"
          mkdir -p renderer/app
          echo "必要なNext.jsのファイルを作成"
          echo "export default function Page() { return <div>Hello World</div> }" > renderer/app/page.tsx
          echo "export default function Layout({ children }) { return <html><body>{children}</body></html> }" > renderer/app/layout.tsx
          echo "body { font-family: sans-serif; }" > renderer/app/globals.css
          echo "@tailwind base; @tailwind components; @tailwind utilities;" >> renderer/app/globals.css
          echo "import './globals.css'; export const metadata = { title: 'SQL Client' }; export default function RootLayout({ children }) { return <html lang='ja'><body>{children}</body></html>; }" > renderer/app/layout.tsx
          echo "ディレクトリ作成完了"
          dir renderer/app
      
      - name: Electronメインプロセスのコンパイル
        run: pnpm compile-electron
      
      - name: renderer用next.configのコピーと設定
        run: |
          cp next.config.js renderer/next.config.js
          (Get-Content renderer/next.config.js) -replace 'distDir:.+,', 'distDir: ".next",' | Set-Content renderer/next.config.js
      
      - name: Next.jsアプリのビルド
        run: |
          cd renderer
          npx next build
      
      - name: ポータブルEXEファイルのビルド
        run: pnpm electron-builder build --win portable
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ビルド成果物のアップロード
        uses: actions/upload-artifact@v4
        with:
          name: sql-client-portable
          path: dist/*.exe
          retention-days: 30 